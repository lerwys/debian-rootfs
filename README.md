debian-rootfs
===============================

Overview
--------

This repository contains scripts to setup a complete rootfs based on
debian-9, docker and all of the necessary packages for a rootfs to be
used in a production environment.

This was designed to be used as a docker bind mount to the
NFS-server available here: https://github.com/lnls-sirius/docker-nfs-server

## Image Versioning

The image versioning scheme follows the pattern:

    <rootfs_debian_version>-kernel-<kernel_version>-<date_YYYYMMDD>

    An example would be the tag:

    9.7-kernel-4.9.0-8-20190201

### Build rootfs/homes

    ./create-all.sh

### Create rootfs TAR

    ./create-tar-rootfs.sh

### Create homefs TAR

    ./create-tar-homefs.sh

### Create image containing entire rootfs (for usage as a volume in nfs-server)

First, the rootfs must be generated by running:

    ./create-rootfs.sh

Then, a tar.gz must be created with the rootfs contents:

    ./create-tar-rootfs.sh

Copy the recently created image to a HTTP server

The new and space-conscious way of bulding the image is to replace
the ENV `ENV ROOTFS_URL` to a URL containing the .rootfs.tar.gz file.
This is needed so we don't need to left the rootfs.tar.gz file in a
docker layer. Instead we can just transfer the tar.gz file via `curl`
and remote it in the same layer.

    Change the URL `ENV ROOTFS_URL` in Dockerfile.rootfs to the URL
    containing the rootfs.tar.gz

Create a `build` directory, as we won't be able to send the rootfs
filesystem to the docker daemon:

    mkdir build && \
    cd build

Build the image

    docker build \
        --build-arg SOURCE_COMMIT=$(git describe --dirty --always --abbrev=10) \
        --build-arg BUILD_DATE=$(date +%Y%m%d-%H%M%S) \
        -f ../Dockerfile.rootfs -t lnls/debian-rootfs .

Most of the time the dockerhub image should be used, not the
locally generated ones. If in doubt use the dockerhub one.

### Create image containing entire homefs (for usage as a volume in nfs-server)

First, the homefs must be generated by running:

    ./create-homes.sh

Then, a tar.gz must be created with the homes contents:

    ./create-tar-homes.sh

Finally, the docker image can be built:

    mkdir -p build && \
        cd build && \
        cp ../homefs.tar.gz .

    docker build \
        --build-arg SOURCE_COMMIT=$(git describe --dirty --always --abbrev=10) \
        --build-arg BUILD_DATE=$(date +%Y%m%d-%H%M%S) \
        -f ../Dockerfile.homefs -t lnls/debian-homefs .

Most of the time the dockerhub image should be used, not the
locally generated ones. If in doubt use the dockerhub one.
